name: Handle Release

on:
  workflow_dispatch:
  create:
  release:
    types: [created]

jobs:
  prepare-ubuntu:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@master

      - name: Update and upgrade Ubuntu packages
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y

      - name: Install dependencies
        run: |
          sudo apt-get install -y build-essential
          sudo apt-get install -y curl
          sudo apt-get install -y wget
          sudo apt-get install -y git

  build-cosmo:
    runs-on: ubuntu-latest
    needs: prepare-ubuntu

    steps:
      - name: Checkout the repository
        uses: actions/checkout@master

      - name: support ape bins and SSL things
        uses: bash ./.github/scripts/setup

      - name: Build Cosmo
        working-directory: /ahgamut/superconfigure
        run: bash ./.github/scripts/cosmo

  handle-release:
    runs-on: ubuntu-latest
    needs: build-cosmo
    strategy:
      fail-fast: false
      matrix:
        result:
          [
            lang,
            compress,
            web,
            aarch64-gcc,
            x86_64-gcc,
            cli,
            datasette,
            pypack1,
            editor,
          ]
    name: ${{ matrix.result }}
    steps:
      - name: Checkout the repository
        uses: actions/checkout@master

      - name: Build ${{ matrix.result }}
        working-directory: /ahgamut/superconfigure
        env:
          COLLECTION: ${{ matrix.result }}
        run: bash ./.github/scripts/collectbuild ${{ matrix.result }}

      - name: Collect into zip
        working-directory: /ahgamut/superconfigure
        env:
          ZFILENAME: ${{ matrix.result }}
        run: bash ./.github/scripts/collectzip

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file_glob: true
          file: "/ahgamut/superconfigure/${{ matrix.result }}*.zip"
          overwrite: true
